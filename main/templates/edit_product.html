{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Edit Product - Sports Zone</title>
<script src="{% static 'js/toast.js' %}"></script>
{% endblock meta %}

{% block content %}
<div class="bg-gray-50 w-full min-h-screen">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Back Navigation -->
    <div class="mb-6">
      <a href="{% url 'main:show_main' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
        ‚Üê Back to Products
      </a>
    </div>
    
    <!-- Form -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 sm:p-8 form-style">
      <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Edit Product</h1>
        <p class="text-gray-600">Update your products</p>
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="hidden mb-6">
        <div class="px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700">
          <span id="errorText"></span>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-400"></div>
        <p class="mt-2 text-gray-600">Loading product data...</p>
      </div>
      
      <form id="editProductForm" class="space-y-6 hidden">
        {% csrf_token %}
        
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
            Product Name *
          </label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-yellow-500 transition-colors" 
            placeholder="Enter product name">
        </div>

        <div>
          <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
            Price *
          </label>
          <input 
            type="number" 
            id="price" 
            name="price" 
            required
            min="0"
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-yellow-500 transition-colors" 
            placeholder="Enter price">
        </div>

        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
            Description *
          </label>
          <textarea 
            id="description" 
            name="description" 
            required
            rows="4"
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-yellow-500 transition-colors" 
            placeholder="Enter product description"></textarea>
        </div>

        <div>
          <label for="thumbnail" class="block text-sm font-medium text-gray-700 mb-2">
            Thumbnail URL
          </label>
          <input 
            type="url" 
            id="thumbnail" 
            name="thumbnail"
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-yellow-500 transition-colors" 
            placeholder="https://example.com/image.jpg">
        </div>

        <div>
          <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
            Category
          </label>
          <select 
            id="category" 
            name="category"
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-yellow-500 transition-colors">
            <option value="sepatu bola">Sepatu Bola</option>
            <option value="kaos kaki">Kaos Kaki</option>
            <option value="jersey">Jersey</option>
            <option value="tas bola">Tas Bola</option>
            <option value="bola">Bola</option>
          </select>
        </div>

        <div>
          <label for="stock" class="block text-sm font-medium text-gray-700 mb-2">
            Stock *
          </label>
          <input 
            type="number" 
            id="stock" 
            name="stock" 
            required
            min="0"
            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:outline-none focus:border-yellow-500 transition-colors" 
            placeholder="Enter stock quantity">
        </div>

        <div class="flex items-center">
          <input 
            type="checkbox" 
            id="is_featured" 
            name="is_featured"
            class="h-4 w-4 text-yellow-400 focus:ring-yellow-500 border-gray-300 rounded">
          <label for="is_featured" class="ml-2 block text-sm text-gray-700">
            Featured Product
          </label>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
          <a href="{% url 'main:show_main' %}" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center">
            Cancel
          </a>
          <button 
            type="submit" 
            id="submitButton"
            class="order-1 sm:order-2 flex-1 bg-yellow-400 text-white px-6 py-3 rounded-md font-medium hover:bg-yellow-500 transition-colors">
            Update Product
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast Notification -->
{% include 'toast.html' %}

<script>
const productId = "{{ produk.id }}";

// Load product data
async function loadProductData() {
  try {
    const response = await fetch(`/json/${productId}/`);
    const data = await response.json();
    
    if (data.length === 0) {
      throw new Error('Product not found');
    }
    
    const product = data[0].fields;
    

    document.getElementById('name').value = product.name;
    document.getElementById('price').value = product.price;
    document.getElementById('description').value = product.description;
    document.getElementById('thumbnail').value = product.thumbnail || '';
    document.getElementById('category').value = product.category || 'bola';
    document.getElementById('stock').value = product.stock;
    document.getElementById('is_featured').checked = product.is_featured;
    
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('editProductForm').classList.remove('hidden');
    
  } catch (error) {
    console.error('Error:', error);
    showToast('Failed to load product data', 'error');
    
    setTimeout(() => {
      window.location.href = "{% url 'main:show_main' %}";
    }, 2000);
  }
}

// Edit Product 
document.getElementById('editProductForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const submitButton = document.getElementById('submitButton');
  const errorMessage = document.getElementById('errorMessage');
  const errorText = document.getElementById('errorText');
  
  // Disable button
  submitButton.disabled = true;
  submitButton.textContent = 'Updating...';
  
  // Hide previous errors
  errorMessage.classList.add('hidden');
  
  try {
    const formData = new FormData(this);
    
    const response = await fetch(`/edit-product-ajax/${productId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken')  
      },
      body: formData
    });
    
    const data = await response.json();
    
    if (response.ok && data.status === 'success') {
      showToast(data.message, 'success');  
      
      setTimeout(() => {
        window.location.href = "{% url 'main:show_main' %}";
      }, 1000);
    } else {
      errorText.textContent = data.message || 'Failed to update product';
      errorMessage.classList.remove('hidden');
      showToast(data.message || 'Failed to update product', 'error');  
      submitButton.disabled = false;
      submitButton.textContent = 'Update Product';
    }
  } catch (error) {
    console.error('Error:', error);
    errorText.textContent = 'An error occurred. Please try again.';
    errorMessage.classList.remove('hidden');
    showToast('Terjadi kesalahan', 'error');  
    submitButton.disabled = false;
    submitButton.textContent = 'Update Product';
  }
});

// Load product data
document.addEventListener('DOMContentLoaded', function() {
  loadProductData();
});
</script>
{% endblock %}